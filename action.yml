name: "L10n.dev AI Localization Automation"
description: "Automatically translate your i18n files using AI-powered localization service"
author: "L10n.dev"
branding:
  icon: "globe"
  color: "blue"

inputs:
  version:
    description: "L10n.dev CLI version"
    default: "latest"
    required: false
  skip-setup-node:
    description: "Skip Node.js setup if already installed in workflow"
    default: "false"
    required: false
  api-key:
    description: "L10n.dev Platform API Key (or set L10N_API_KEY env variable)"
    required: false
  config-file:
    description: "Path to the translation config file"
    default: "ai-l10n.config.json"
    required: false
  working-directory:
    description: "Working directory to run the translation (useful for monorepos)"
    default: "."
    required: false
  pull-request:
    description: "Create a pull request with the changes"
    default: "false"
    required: false
  commit-message:
    description: "Commit message"
    default: "feat: update translations via L10n.dev"
    required: false
  pull-request-title:
    description: "Pull request title"
    default: "feat: update translations via L10n.dev"
    required: false
  commit-author-name:
    description: "Git commit author name"
    default: "L10n.dev"
    required: false
  commit-author-email:
    description: "Git commit author email"
    default: "support@l10n.dev"
    required: false
  process-own-commits:
    description: "Process commits made by this action"
    default: "false"
    required: false

runs:
  using: "composite"
  steps:
    - name: Check for own commits
      if: inputs.process-own-commits == 'false'
      shell: bash
      run: |
        if [[ "${{ github.event.head_commit.author.email }}" == "${{ inputs.commit-author-email }}" ]]; then
          echo "Skipping: commit was made by this action"
          echo "SKIP_TRANSLATION=true" >> $GITHUB_ENV
        else
          echo "SKIP_TRANSLATION=false" >> $GITHUB_ENV
        fi

    - name: Setup Node.js
      if: env.SKIP_TRANSLATION != 'true' && inputs.skip-setup-node == 'false'
      uses: actions/setup-node@v4
      with:
        node-version: "18"

    - name: Install ai-l10n CLI
      if: env.SKIP_TRANSLATION != 'true'
      shell: bash
      run: |
        if [ "${{ inputs.version }}" = "latest" ]; then
          npm install -g ai-l10n
        else
          npm install -g ai-l10n@${{ inputs.version }}
        fi

    - name: Run batch translation
      if: env.SKIP_TRANSLATION != 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        # Set API key only if provided as input
        if [ -n "${{ inputs.api-key }}" ]; then
          export L10N_API_KEY="${{ inputs.api-key }}"
        fi

        if [ ! -f "${{ inputs.config-file }}" ]; then
          echo "Error: Config file '${{ inputs.config-file }}' not found"
          exit 1
        fi
        npx ai-l10n batch ${{ inputs.config-file }}

    - name: Check for changes
      if: env.SKIP_TRANSLATION != 'true'
      id: git-check
      shell: bash
      run: |
        git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT

    - name: Create Pull Request
      if: env.SKIP_TRANSLATION != 'true' && steps.git-check.outputs.has_changes == 'true' && inputs.pull-request == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ github.token }}
        commit-message: ${{ inputs.commit-message }}
        title: ${{ inputs.pull-request-title }}
        branch: translations-${{ github.run_number }}
        delete-branch: true
        author: ${{ inputs.commit-author-name }} <${{ inputs.commit-author-email }}>

    - name: Commit and push changes directly
      if: env.SKIP_TRANSLATION != 'true' && steps.git-check.outputs.has_changes == 'true' && inputs.pull-request == 'false'
      shell: bash
      run: |
        CURRENT_BRANCH="${{ github.ref_name }}"
        
        # Warn if attempting to push to protected branches
        if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" ]]; then
          echo "⚠️ Warning: Attempting to push directly to '$CURRENT_BRANCH' branch"
          echo "This may fail if the branch is protected. Consider using pull-request: true"
        fi
        
        git config user.name "${{ inputs.commit-author-name }}"
        git config user.email "${{ inputs.commit-author-email }}"
        git add .
        git commit -m "${{ inputs.commit-message }}"
        git push
